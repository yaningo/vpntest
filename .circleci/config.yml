version: 2
jobs:
  test-vpn:
    machine:
      image: circleci/classic:latest
    steps:
    - run:
        name: Install OpenVPN
        command: |
          sudo apt-get update -y && sudo apt-get install openvpn
          sudo apt-get upgrade openvpn
        
    - run:
        name: Init VPN
        command: |
          #echo "$VPN_CONFIG" > raw.txt
          #cat raw.txt | tr " " "\n" | base64 --decode >> config.ovpn
          echo $VPN_CONFIG | base64 --decode >> config.ovpn
          printf "\"$VPN_USER\\n$VPN_PASSWORD\\n\"" >> vpn.login
          echo "Public IP is $(wget -qO- http://checkip.amazonaws.com | tee initial.ip)"
          route -n
    - run:
        name: Connect to VPN
        command: |
          sudo openvpn --config config.ovpn --auth-user-pass vpn.login > openvpn.log 2>&1 &
          #sudo /bin/bash -c 'echo "nameserver 8.8.8.8" > /run/resolvconf/resolv.conf'
          while [ -n "$(ip addr show tun0 2>&1 > /dev/null)" ]; do
            sleep 0.1;
          done
            echo "VPN client connected!"
            echo "Public IP is $(wget -qO- http://checkip.amazonaws.com | tee initial.ip)"
            route -n
            ifconfig -a
    - run:
        name: Do stuff in our infrastructure
        command: |
          sudo echo "Public IP is $(wget -qO- http://checkip.amazonaws.com | tee initial.ip)"
          sudo route -n
          sudo ifconfig -a
          
    - store_artifacts:
          path: ./openvpn.log
          destination: openvpn.log
            
workflows:
  version: 2
  build-and-release:
    jobs:
    - test-vpn
