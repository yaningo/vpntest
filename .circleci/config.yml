version: 2.1
jobs: 
  test-vpn:
    machine:
      image: ubuntu-1604:201903-01
    
    steps:
      - run:
          name: Install OpenVPN
          command: |
            sudo apt-get update -y && sudo apt-get install openvpn
            #sudo apt-get install network-manager-openvpn -y
            #sudo apt-get upgrade openvpn
            #sudo openvpn --version
        
      - run:
          name: Init le VPN
          command: |
            echo $VPN_CONFIG | base64 --decode >> config.ovpn
            #printf "\"$VPN_USER\\n$VPN_PASSWORD\\n\"" >> vpn.login
            echo "Initial public IP is $(wget -qO- http://checkip.amazonaws.com | tee initial.ip)"  

      - run:
          name: Connect to VPN
          background: true
          command: |
            echo "Connecting VPN client..."
            sudo openvpn --config config.ovpn > openvpn.log 2>&1 &
            #sudo openvpn --config config.ovpn --daemon -f openvpn.log
            #sudo openvpn --config config.ovpn --auth-user-pass vpn.login > openvpn.log 2>&1 &
            #sudo openvpn --config config.ovpn --auth-user-pass vpn.login 2>&1 &
                   
      - run:
          name: Check VPN connection
          command: |
            while [ ! (-f openvpn.log) ] do;
             sleep 1
             echo "Waiting for VPN client log";
            done
            echo "Public IP is $(wget -qO- http://checkip.amazonaws.com | tee initial.ip)" > currentIP.txt
            #echo "Public IP is $(wget -qO- http://checkip.amazonaws.com | tee initial.ip)"
            ip route show default >> currentIP.txt
            route -n
            ifconfig -a
            
      - store_artifacts:
          path: /home/circleci/project/openvpn.log
          destination: openvpn.log
          
      - store_artifacts:
          path: /home/circleci/project/currentIP.txt
          destination: currentIP.txt
                                                                     
      - run:
          name: Do stuff in our infrastructure
          command: |
            ip route
            ifconfig -a
            echo "Ping-ing VPN server private IP"
            ping -c 5 172.31.40.6
             
      - run:
              name: Disconnect from OpenVPN
              command: sudo killall openvpn || true
              when: always
            
workflows:
  version: 2
  build-and-release:
    jobs:
    - test-vpn
